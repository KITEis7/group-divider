<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Party Divider</title>
    <style>
        body { font-family: sans-serif; max-width: 500px; margin: 20px auto; padding: 20px; background: #f4f4f9; color: #333; }
        textarea { width: 100%; height: 150px; margin-bottom: 15px; padding: 12px; border-radius: 8px; border: 1px solid #ccc; font-size: 16px; box-sizing: border-box; }
        
        .button-group { display: flex; flex-direction: column; gap: 10px; }
        
        button { 
            width: 100%; padding: 15px; border: none; border-radius: 8px; 
            font-weight: bold; font-size: 1rem; cursor: pointer; transition: 0.2s;
        }

        .btn-shuffle { background: #ebedef; color: #4f5660; border: 1px solid #ccc; }
        .btn-shuffle:active { background: #dbdee1; }

        .btn-main { background: #5865F2; color: white; }
        .btn-main:active { background: #4752C4; transform: scale(0.98); }

        #result { 
            background: #fff; padding: 15px; border-radius: 8px; border: 2px solid #5865F2; 
            white-space: pre-wrap; margin-top: 15px; display: none; font-family: monospace; font-size: 0.95rem;
        }
        .hint { font-size: 0.85rem; color: #666; margin-top: 10px; text-align: center; line-height: 1.4; }
        .discord-app-link {
            display: block;
            text-align: center;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #5865F2;
            text-decoration: none;
        }
        .discord-app-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>

    <h2 style="text-align: center;">ğŸ‘¥ ã‚ã‘ã‚ã‘</h2>
    
    <textarea id="memberList" placeholder="åå‰ã‚’ã‚¹ãƒšãƒ¼ã‚¹ã‚„æ”¹è¡Œã§åŒºåˆ‡ã£ã¦å…¥åŠ›..."></textarea>

    <div class="button-group">
        <button class="btn-shuffle" onclick="divide(false)">ã‚ã‘ã‚ã‘ / ã‚‚ã†ä¸€åº¦</button>
        
        <button id="confirmBtn" class="btn-main" onclick="tryOpenDiscordApp()" style="display: none;">çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ Discordã¸</button>
    </div>

    <div id="result"></div>
    <p class="hint">
        ã€Œã‚ã‘ã‚ã‘ã€ã§æŒ¯ã‚Šåˆ†ã‘ã‚‰ã‚Œã¾ã™ã€‚<br>
        ã€ŒDiscordã¸ã€ã‚’æŠ¼ã™ã¨ã‚³ãƒ”ãƒ¼ã—ã¦ï¼ƒãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼å…¨ä½“ãƒ†ã‚­ã‚¹ãƒˆã‚’é–‹ãã¾ã™ã€‚
    </p>

    <script>
        const DISCORD_CHANNEL_ID = '1444265860947509300'; // ãƒãƒ£ãƒ³ãƒãƒ«IDã®ã¿
        const DISCORD_GUILD_ID = '1376118555078164501'; // ã‚µãƒ¼ãƒãƒ¼IDã®ã¿
        const DISCORD_APP_URI_BASE = `discord://discord.com/channels/${DISCORD_GUILD_ID}/${DISCORD_CHANNEL_ID}`;

        function toFullWidth(n) {
            return String(n).replace(/[0-9]/g, function(s) {
                return String.fromCharCode(s.charCodeAt(0) + 0xFEE0);
            });
        }

        let currentResultText = ""; // ã‚³ãƒ”ãƒ¼ï¼†Discordã¸ã®é·ç§»ã®ãŸã‚ã«çµæœã‚’ä¿æŒ

        function divide(isFinal) { // isFinal ã¯ç¾åœ¨ã¯ä½¿ã‚ã‚Œã¦ã„ã¾ã›ã‚“ãŒã€å°†æ¥ã®ãŸã‚ã«æ®‹ã—ã¾ã™
            const rawInput = document.getElementById('memberList').value;
            let members = rawInput.split(/[\n\sã€€]+/).map(m => m.trim()).filter(m => m !== "");
            
            if (members.length === 0) { 
                alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„'); 
                return; 
            }

            const count = members.length;
            // 4äºº1çµ„ã‚’åŸºæœ¬ã¨ã—ã€ä½™ã‚Šã‚’å‡ç­‰ã«é…åˆ†
            const baseGroupSize = 4;
            const numGroups = Math.ceil(count / baseGroupSize);
            const remainder = count % numGroups;
            const groupSizes = Array(numGroups).fill(Math.floor(count / numGroups));
            for (let i = 0; i < remainder; i++) {
                groupSizes[i]++;
            }

            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«
            for (let i = members.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [members[i], members[j]] = [members[j], members[i]];
            }

            // æŒ¯ã‚Šåˆ†ã‘
            let groups = [];
            let memberIndex = 0;
            for (let i = 0; i < numGroups; i++) {
                const currentGroup = members.slice(memberIndex, memberIndex + groupSizes[i]);
                groups.push(currentGroup);
                memberIndex += groupSizes[i];
            }

            // ãƒ†ã‚­ã‚¹ãƒˆæ•´å½¢
            let resultLines = [];
            groups.forEach((group, i) => {
                const fullWidthNum = toFullWidth(i + 1);
                // Discordã®ãƒãƒ£ãƒ³ãƒãƒ«æŠ•ç¨¿å½¢å¼ã«åˆã‚ã›ã‚‹ï¼ˆä¾‹: #ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼1ãƒ†ã‚­ã‚¹ãƒˆ, ãƒ¡ãƒ³ãƒãƒ¼1,ãƒ¡ãƒ³ãƒãƒ¼2,...ï¼‰
                resultLines.push(`#â ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼${fullWidthNum}ãƒ†ã‚­ã‚¹ãƒˆã€€,${group.join(',')}`);
            });
            currentResultText = resultLines.join('\n'); // çµæœã‚’ä¿æŒ

            // ç”»é¢è¡¨ç¤º
            const resultDiv = document.getElementById('result');
            resultDiv.innerText = currentResultText;
            resultDiv.style.display = 'block';

            // ç¢ºå®šãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
            document.getElementById('confirmBtn').style.display = 'block';
        }

        // Discordã‚¢ãƒ—ãƒªã¸ã®é·ç§»ã‚’è©¦ã¿ã‚‹é–¢æ•°
        function tryOpenDiscordApp() {
            if (!navigator.clipboard) {
                alert("ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚");
                window.open(DISCORD_CHANNEL_URL, '_blank'); // Webç‰ˆã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                return;
            }

            navigator.clipboard.writeText(currentResultText).then(() => {
                // ã‚³ãƒ”ãƒ¼æˆåŠŸ
                let discordUri = DISCORD_APP_URI_BASE;
                
                // OSæ¤œå‡º (ç°¡æ˜“çš„)
                const userAgent = navigator.userAgent || navigator.vendor || window.opera;
                let os = "unknown";
                if (/windows phone/i.test(userAgent) || /win(dows )?/.test(userAgent)) {
                    os = "windows";
                } else if (/android/i.test(userAgent)) {
                    os = "android"; // Androidã‚¢ãƒ—ãƒªã‚‚URIã‚¹ã‚­ãƒ¼ãƒ ã§é–‹ã‘ã¾ã™
                } else if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                    os = "ios"; // iOSã‚¢ãƒ—ãƒªã‚‚URIã‚¹ã‚­ãƒ¼ãƒ ã§é–‹ã‘ã¾ã™
                } else if (/macintosh|mac os x/.test(userAgent)) {
                    os = "macos";
                } else if (/linux/i.test(userAgent)) {
                    os = "linux";
                }

                // URIã‚¹ã‚­ãƒ¼ãƒ ã‚’è©¦ã¿ã‚‹ (Windows, macOS, Linux, Android, iOSã§å‹•ä½œã™ã‚‹å¯èƒ½æ€§ã‚ã‚Š)
                // Discordã‚¢ãƒ—ãƒªãŒã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã€URIã‚¹ã‚­ãƒ¼ãƒ ãŒç™»éŒ²ã•ã‚Œã¦ã„ã‚Œã°æ©Ÿèƒ½ã—ã¾ã™ã€‚
                // ã“ã‚Œã§é–‹ã‘ãªã„å ´åˆã¯ã€Webç‰ˆã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã•ã›ã‚‹ã®ãŒç¾å®Ÿçš„ã§ã™ã€‚
                
                // Safari (macOS/iOS) ã§ã¯ã€window.open() ãŒç›´æ¥ URI ã‚¹ã‚­ãƒ¼ãƒ ã‚’
                // å‡¦ç†ã—ãªã„å ´åˆãŒã‚ã‚‹ã®ã§ã€å·¥å¤«ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚
                // ã—ã‹ã—ã€å¤šãã®ãƒ¢ãƒ€ãƒ³ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ window.location.href ã§è©¦ã›ã¾ã™ã€‚

                const link = document.createElement('a');
                link.href = discordUri;
                link.style.display = 'none';
                document.body.appendChild(link);

                let opened = false;
                // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’è¨­å®šã—ã¦ã€ã‚¢ãƒ—ãƒªãŒé–‹ã‹ãªã‹ã£ãŸå ´åˆã®å‡¦ç†ã‚’å®šç¾©
                const timeout = setTimeout(() => {
                    if (!opened) {
                        // ã‚¢ãƒ—ãƒªãŒé–‹ã‹ãªã‹ã£ãŸå ´åˆ (ã¾ãŸã¯ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã—ãŸå ´åˆ)
                        // Webç‰ˆã¸ã®ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã€è‡ªå‹•ã§Webç‰ˆã«é·ç§»ã•ã›ã‚‹
                        alert('Discordã‚¢ãƒ—ãƒªãŒé–‹ã‹ãªã„ã€ã¾ãŸã¯æ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚Webç‰ˆã«é·ç§»ã—ã¾ã™ã€‚');
                        window.open('https://discord.com/channels/' + DISCORD_GUILD_ID + '/' + DISCORD_CHANNEL_ID, '_blank');
                    }
                }, 1500); // 1.5ç§’å¾Œã«ãƒã‚§ãƒƒã‚¯

                try {
                    // link.click() ã¯ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®ç†ç”±ã§ç›´æ¥å®Ÿè¡Œã§ããªã„å ´åˆãŒã‚ã‚‹ã®ã§ã€
                    // window.location.href ã‚’ä½¿ã†ã®ãŒä¸€èˆ¬çš„ã§ã™ã€‚
                    // ã—ã‹ã—ã€ã‚¢ãƒ—ãƒªèµ·å‹•ã‚’è©¦ã¿ã‚‹ãŸã‚ã« link.click() ã‚‚è©¦ã—ã¦ã¿ã¾ã™ã€‚
                    // å¤šãã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œï¼ˆãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ãªã©ï¼‰ã‹ã‚‰
                    // å‘¼ã³å‡ºã•ã‚ŒãŸå ´åˆã®ã¿ã€link.click() ãŒæˆåŠŸã—ã¾ã™ã€‚
                    
                    // Safari (iOS/macOS) ã§ã¯ã€`window.open(discordUri)` ã®æ–¹ãŒ
                    // `window.location.href` ã‚ˆã‚Šã€URIã‚¹ã‚­ãƒ¼ãƒ ã‚’å‡¦ç†ã—ã‚„ã™ã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
                    if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
                        window.open(discordUri);
                    } else {
                        window.location.href = discordUri;
                    }
                    opened = true; // èµ·å‹•ã‚’è©¦ã¿ãŸãƒ•ãƒ©ã‚°
                    clearTimeout(timeout); // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã‚’ã‚¯ãƒªã‚¢
                    
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚¢ãƒ—ãƒªã§é–‹ã„ãŸã‹ç¢ºèªã™ã‚‹ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹
                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã€Œã¯ã„ã€ã‚’æŠ¼ã›ã°ãã®ã¾ã¾ï¼ˆã‚¢ãƒ—ãƒªãŒé–‹ã„ãŸã¨ä»®å®šï¼‰ã€
                    // ã€Œã„ã„ãˆã€ã‚’æŠ¼ã›ã°Webç‰ˆã«é·ç§»ã•ã›ã‚‹ã€ã¨ã„ã£ãŸã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–ãªå‡¦ç†ã‚‚å¯èƒ½ã§ã™ãŒã€
                    // ã“ã“ã§ã¯ã‚·ãƒ³ãƒ—ãƒ«ã«Webç‰ˆã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã«ç•™ã‚ã¾ã™ã€‚
                    // alert('Discordã‚¢ãƒ—ãƒªã§é–‹ã‹ã‚ŒãŸã¯ãšã§ã™ã€‚é–‹ã‹ã‚Œãªã‹ã£ãŸå ´åˆã¯Webç‰ˆã«é·ç§»ã—ã¾ã™ã€‚');
                    
                    // ã‚¢ãƒ—ãƒªãŒé–‹ã„ãŸã‹ã©ã†ã‹ã®ç¢ºå®Ÿãªåˆ¤å®šã¯JavaScriptã§ã¯ã§ããªã„ãŸã‚ã€
                    // æ™‚é–“å·®ã§Webç‰ˆã¸ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚’æç¤ºã™ã‚‹ã®ãŒç¾å®Ÿçš„ã§ã™ã€‚
                    // ä¸Šè¨˜ã®timeoutå‡¦ç†ãŒãã‚Œã‚’æ‹…ã„ã¾ã™ã€‚

                } catch (e) {
                    // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆ
                    clearTimeout(timeout);
                    alert('Discordã‚¢ãƒ—ãƒªã‚’é–‹ã‘ã¾ã›ã‚“ã§ã—ãŸã€‚Webç‰ˆã«é·ç§»ã—ã¾ã™ã€‚\nã‚¨ãƒ©ãƒ¼: ' + e.message);
                    window.open('https://discord.com/channels/' + DISCORD_GUILD_ID + '/' + DISCORD_CHANNEL_ID, '_blank');
                }

            }).catch(err => {
                // ã‚³ãƒ”ãƒ¼å¤±æ•—
                alert('ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã¸ã®ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Discord Webç‰ˆã«é·ç§»ã—ã¾ã™ã€‚');
                window.open('https://discord.com/channels/' + DISCORD_GUILD_ID + '/' + DISCORD_CHANNEL_ID, '_blank');
            });
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«ã€Discordã‚¢ãƒ—ãƒªã¸ã®ãƒªãƒ³ã‚¯ã‚’è¡¨ç¤ºã™ã‚‹ã‹ã©ã†ã‹ã‚’åˆ¤æ–­ã™ã‚‹ (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
        // ä¾‹: Windows PCã§ã‚ã‚‹ã“ã¨ãŒæ¤œå‡ºã•ã‚ŒãŸã‚‰ã€ã‚¢ãƒ—ãƒªã¸ã®ãƒªãƒ³ã‚¯ã‚’æç¤ºã™ã‚‹
        // function suggestAppLink() {
        //     const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        //     if (/windows/i.test(userAgent)) {
        //         const hintElement = document.querySelector('.hint');
        //         const appLink = document.createElement('a');
        //         appLink.href = DISCORD_APP_URI_BASE;
        //         appLink.className = 'discord-app-link';
        //         appLink.textContent = 'â–¼ Discordã‚¢ãƒ—ãƒªã§é–‹ã';
        //         appLink.target = '_blank'; // æ–°ã—ã„ã‚¿ãƒ–ã§é–‹ã
        //         hintElement.parentNode.insertBefore(appLink, hintElement.nextSibling);
        //     }
        // }
        // document.addEventListener('DOMContentLoaded', suggestAppLink);

    </script>
</body>
</html>